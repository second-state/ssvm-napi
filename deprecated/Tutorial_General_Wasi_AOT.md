# How to run wasm applications with ssvm-napi (General wasm32-wasi and ahead-of-time mode)

## Environment Setup for Rust, Nodejs, and ssvmup

```bash
$ sudo apt-get update
$ sudo apt-get -y upgrade
$ sudo apt install build-essential curl wget git vim libboost-all-dev

$ curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
$ source $HOME/.cargo/env
$ cargo install cargo-wasi

$ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh | bash

$ export NVM_DIR="$HOME/.nvm"
$ [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
$ [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

$ nvm install v14.2.0
$ nvm use v14.2.0

$ npm i -g ssvmup
```

## Example 1. RSA Key Pair Application

### Create a new rust project

```bash
cargo new rsa-example-aot
cd rsa-example-aot
```

### Modify the cargo config file

Replace the content of `Cargo.toml` file with the following code section:

```toml
[package]
name = "rsa_example_aot"
version = "0.1.0"
authors = ["ubuntu"]
edition = "2018"
# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html
[dependencies]
rand = "0.7.3"
rsa = { version = "0.2.0", features = ["serde1"] }
serde = { version = "1.0.110", features = ["derive"] }
serde_json = "1.0.53"
clap = "2.33.1"
```

### Write Rust code

Below is the entire content of the `src/main.rs` file.

```rust
use clap::{Arg, App, SubCommand};
use rsa::{PublicKey, RSAPublicKey, RSAPrivateKey, PaddingScheme};
use rand::rngs::OsRng;
use serde::{Serialize, Deserialize};
#[derive(Serialize, Deserialize)]
struct RSAKeyPair {
  rsa_private_key: RSAPrivateKey,
  rsa_public_key: RSAPublicKey
}
pub fn generate_key_pair (bits: i32) -> String {
  let mut rng = OsRng;
  let private_key = RSAPrivateKey::new(&mut rng, bits as usize).expect("failed to generate a key");
  let public_key = private_key.to_public_key();
  let key_pair = RSAKeyPair {rsa_private_key: private_key, rsa_public_key: public_key};
  return serde_json::to_string(&key_pair).unwrap();
}
pub fn decrypt (pk: &str, data: &[u8]) -> Vec<u8> {
  let private_key: RSAPrivateKey = serde_json::from_str(pk).unwrap();
  return private_key.decrypt(PaddingScheme::PKCS1v15, data).expect("failed to decrypt");
}
pub fn encrypt (pk: &str, data: &[u8]) -> Vec<u8> {
  let mut rng = OsRng;
  let public_key: RSAPublicKey = serde_json::from_str(pk).unwrap();
  return public_key.encrypt(&mut rng, PaddingScheme::PKCS1v15, data).expect("failed to encrypt");
}
fn main() {
  let matches = App::new("RSA Example")
    .subcommand(SubCommand::with_name("generate_key_pair")
                .arg(Arg::with_name("bits")
                     .short("b")
                     .long("bits")
                     .value_name("BITS")
                     .index(1)
                     ))
    .subcommand(SubCommand::with_name("decrypt")
                .arg(Arg::with_name("private_key")
                     .short("k")
                     .long("key")
                     .value_name("PRIVATE_KEY_JSON")
                     .required(true)
                     .index(1)
                     )
                .arg(Arg::with_name("data")
                     .short("d")
                     .long("data")
                     .value_name("DATA_JSON")
                     .required(true)
                     .index(2)
                     ))
    .subcommand(SubCommand::with_name("encrypt")
                .arg(Arg::with_name("public_key")
                     .short("k")
                     .long("key")
                     .value_name("PUBLIC_KEY_JSON")
                     .required(true)
                     .index(1)
                     )
                .arg(Arg::with_name("data")
                     .short("d")
                     .long("data")
                     .value_name("DATA_JSON")
                     .required(true)
                     .index(2)
                     ))
    .get_matches();
  if let Some(matches) = matches.subcommand_matches("generate_key_pair") {
    let bits = matches
      .value_of("bits")
      .and_then(|x| x.parse::<i32>().ok())
      .unwrap_or(2048);
    println!("{}", generate_key_pair(bits));
  } else if let Some(matches) = matches.subcommand_matches("encrypt") {
    let pk = matches
      .value_of("public_key")
      .unwrap();
    let data = matches
      .value_of("data")
      .unwrap();
    println!("data:'{}'", data);
    let data_bytes = data.as_bytes();
    let result = encrypt(pk, &data_bytes);
    let result_json = serde_json::to_string(&result).unwrap();
    println!("encrypt:'{}'", result_json);
  } else if let Some(matches) = matches.subcommand_matches("decrypt") {
    let pk = matches
      .value_of("private_key")
      .unwrap();
    let data = matches
      .value_of("data")
      .and_then(|x| serde_json::from_str::<Vec<u8>>(x).ok())
      .expect("failed to decode json string");
    println!("data:'{}'", serde_json::to_string(&data).unwrap());
    let result = decrypt(pk, &data);
    let result_utf8 = String::from_utf8(result).expect("failed to decode utf8 bytes");
    println!("decrypt:'{}'", result_utf8);
  }
}
```

### Build the WASM bytecode with cargo wasm32-wasi backend

```bash
cargo wasi build --release
```

After building, our target wasm file is located at `target/wasm32-wasi/release/rsa-example.wasm`.

### Install SSVM addon for your application

```bash
npm install ssvm
```

or if you want to build from source:

```bash
export CXX=g++-9
npm install --build-from-source https://github.com/second-state/ssvm-napi
```

### Use SSVM addon
After installing the SSVM addon, we could now interact with `rsa_example.wasm` generated by wasm32-wasi backend in Node.js.

- Create a new folder at any path you want. (e.g. `mkdir application`)
- Copy `rsa_example.wasm` into your application directory. (e.g. `cp rsa_example.wasm <path_to_your_application_folder>`)
- Create js file `main.js` and `lib.js` with the following content:

#### The entire content of `main.js`:

```javascript
const { generate_key_pair } = require('./lib.js');

console.log( "Generate Key Pair:" );
console.time('Generate_Key_Pair_Compile_And_Run');
generate_key_pair(2048)
console.timeEnd('Generate_Key_Pair_Compile_And_Run');

console.log( "Test codecache" );
console.log( "Generate Key Pair:" );
console.time('Generate_Key_Pair_CACHE');
generate_key_pair(2048)
console.timeEnd('Generate_Key_Pair_CACHE');

console.log( "Test codecache2" );
console.log( "Generate Key Pair:" );
console.time('Generate_Key_Pair_CACHE');
generate_key_pair(2048)
console.timeEnd('Generate_Key_Pair_CACHE');
```

#### The entire content of `lib.js`:

```javascript
let vm;
/**
* @param {number} bits
* @returns {string}
*/
module.exports.generate_key_pair = function(bits) {
	return vm.RunAot({
		"args": ["generate_key_pair", bits]
	});
};

const ssvm = require('ssvm');
const path = require('path').join(__dirname, 'target/wasm32-wasi/release/rsa_example_aot.wasm');

vm = new ssvm.VM(path, {"DisableWasmBindgen": true});
```

### Execute and check results

Please notice that ssvm.js is running in aot mode.
It will take a few minutes to compile the wasm bytecode into native binary.
SSVM Napi supports code cache, so you can find that it took 1 minute and 44 seconds to compile and run the first time.
And the remaining two execution took 905 ms and 856 ms only.

```bash
$ node main.js

Generate Key Pair:
2020-07-10 16:37:54,476 INFO [default] compile start
2020-07-10 16:37:55,511 INFO [default] verify start
2020-07-10 16:37:55,703 INFO [default] optimize start
2020-07-10 16:39:08,531 INFO [default] codegen start
2020-07-10 16:39:38,820 INFO [default] compile done
{"rsa_private_key":{"n":[1983117373,2247399852,3418733532,4289161310,927612907,1101523362,2827939280,1413757326,2495300994,2358531003,4181075018,50883607,3324275287,2334324690,2685083620,2348780898,2767351415,327053028,1154932497,3327809547,4261663267,1744195352,1824322712,745917304,602213007,65438281,3543166904,570213504,340858058,3574357884,1631976464,3219245193,216547475,3333845260,169550770,1447060135,4256419845,3130861173,4235807035,3059174324,3721369962,581339731,2849030407,3693804299,1865913092,3117006541,1171233254,1948144833,515873677,1692255690,1431944722,182446396,2309052522,1686786413,1792202215,3398549959,2501709357,2939165553,2594483209,3034035264,1941147101,2184106274,789517948,3202069254],"e":[65537],"d":[3963203713,2907246659,3366985422,576748352,1161370977,2097013433,1354819067,2421943565,3888419313,2139594718,1412195722,4050407029,1381602200,1100638271,534047261,3574181614,2522624904,3874177184,262070841,1062086928,4013167632,2869200350,3165854798,1700554383,3732476279,1104502897,1881890674,2993540464,2014071387,253737994,2656500765,1614889361,2746729114,3140232998,3480065062,166963359,278356859,656398101,2063611529,2609540709,2728221049,1070307602,71071743,3805639283,457792205,3536688013,638543397,2718371060,1299890561,3746359370,1055402468,3836576900,3184520317,3521812408,3482527924,17814868,1098242002,3469366472,233014848,3994648154,1083334490,2669134302,3571269573,781450106],"primes":[[3260553329,3626617802,3778306423,2676159408,4017970995,2629845941,172526436,3157327837,1098938159,1741158604,333988906,3529905269,1247870457,555586149,518022149,2406510384,1815346384,1618114181,3752386498,354100011,2614124617,164563692,1135916519,3830626434,1954641310,4219196309,2298100810,1235601987,3703419860,449830155,1236359119,3527520607],[2737283725,4201033096,2907195163,748955735,901596992,2468200643,1019433158,887683740,873395265,737106587,4053395608,1836047485,27769815,3614005007,3863931014,1094152197,274007989,1257574031,928709123,2711508767,3110788743,4186797926,4193649553,3147532630,1718836571,191792376,3413814851,2956224537,2236750218,1158092872,2575968924,3898710810]]},"rsa_public_key":{"n":[1983117373,2247399852,3418733532,4289161310,927612907,1101523362,2827939280,1413757326,2495300994,2358531003,4181075018,50883607,3324275287,2334324690,2685083620,2348780898,2767351415,327053028,1154932497,3327809547,4261663267,1744195352,1824322712,745917304,602213007,65438281,3543166904,570213504,340858058,3574357884,1631976464,3219245193,216547475,3333845260,169550770,1447060135,4256419845,3130861173,4235807035,3059174324,3721369962,581339731,2849030407,3693804299,1865913092,3117006541,1171233254,1948144833,515873677,1692255690,1431944722,182446396,2309052522,1686786413,1792202215,3398549959,2501709357,2939165553,2594483209,3034035264,1941147101,2184106274,789517948,3202069254],"e":[65537]}}
Generate_Key_Pair_Compile_And_Run: 1:44.926 (m:ss.mmm)
Test codecache
Generate Key Pair:
{"rsa_private_key":{"n":[3096848235,1797968459,1804302772,1704926852,2069976515,3087669824,4157421854,2150556660,3691897224,3610398013,2841789364,3403741232,2890327785,1333787269,90811988,3921854237,2633931107,907659922,3765941586,3750218241,3590267261,1372768177,653924617,3651415365,1998046315,3272284832,1778261880,1658693700,974877212,3600651526,468587548,3203576471,3153644958,1499405536,751840724,1365860369,727452873,1570941737,670745584,1377125532,137328187,1391716148,3667723573,3290547470,1099305624,491603592,4269240615,476878823,2678948031,2333283605,1326807013,1203424255,3059150094,758553098,1013703344,2482785364,1439334649,1019660776,2315603403,1490965813,232932239,2545945906,1220165920,3038230755],"e":[65537],"d":[667859729,2845641205,771129649,570206897,1112700604,4036243977,1755432443,1909592619,3831339351,3883786410,3296775394,1394806769,1961400318,1742085518,797467422,1701332594,4271397992,2170835268,3731546692,1179415431,1059003537,194004393,1309691433,2565543508,2092851719,3377909655,2603558755,3911385738,1170137073,1765925030,2740742901,1308408932,3082275592,2496439867,2617244069,1945703773,2035229530,2742193775,2543866800,3273234180,3902044181,2416151980,3334250320,318409839,2812436608,3614849706,726214354,1620636788,3511253535,1605499309,2948727509,1287801236,731214009,185423821,2560454048,476958055,3799655598,2939619199,2796516634,1395174851,224628046,92508791,3844218431,2930770558],"primes":[[2340115171,264422593,2633237044,1610022469,1686718305,1847999691,1669187428,2219220498,3968417980,352671343,4227953747,210146546,3377597624,3571400343,3229458893,2170796540,2985295838,2341774529,1693399060,3226217781,543606750,2983234993,308243472,27464910,2078085090,733428876,2083306974,2380935351,3429506921,440362201,2683931237,3836425558],[1736677337,3979059478,559262679,11422300,3534577406,669933558,1324445504,1293184657,1531749471,4279731603,185608725,2700203224,628063552,2554692326,261539079,2918457288,542742069,3861182639,1118575070,3333659657,4293976369,4165933184,3552649147,2111198244,2039904865,1164974774,1608442694,552686728,4060946402,1776849867,3924745747,3401369720]]},"rsa_public_key":{"n":[3096848235,1797968459,1804302772,1704926852,2069976515,3087669824,4157421854,2150556660,3691897224,3610398013,2841789364,3403741232,2890327785,1333787269,90811988,3921854237,2633931107,907659922,3765941586,3750218241,3590267261,1372768177,653924617,3651415365,1998046315,3272284832,1778261880,1658693700,974877212,3600651526,468587548,3203576471,3153644958,1499405536,751840724,1365860369,727452873,1570941737,670745584,1377125532,137328187,1391716148,3667723573,3290547470,1099305624,491603592,4269240615,476878823,2678948031,2333283605,1326807013,1203424255,3059150094,758553098,1013703344,2482785364,1439334649,1019660776,2315603403,1490965813,232932239,2545945906,1220165920,3038230755],"e":[65537]}}
Generate_Key_Pair_CACHE: 905.033ms
Test codecache2
Generate Key Pair:
{"rsa_private_key":{"n":[836640533,2811245416,716324048,2993722125,2443208307,1207933224,1763966872,768230429,2698832834,1722770511,3481056265,2483454227,1581944854,1854441585,1267604383,225507178,2248629754,222796813,436665417,2767570513,1751460175,3567334893,158551180,1936216845,4143458509,3490367465,4084860363,1721850123,1379384883,3483780499,4242230917,2422006539,1537799438,3474259944,2996099166,2549725424,2874957611,1494382397,462245471,1722720530,1143308317,1819787583,3197383042,4024279149,1536879499,298310184,1814074952,136661287,782643024,1746597339,900351955,2634931530,4259949916,2983184200,2755062806,1675383366,4274792210,2929612017,3247824938,3718374389,1609377025,274078680,2522020422,3380278664],"e":[65537],"d":[3718516409,403739405,3841152456,2261798446,4084337024,752106852,2623138215,4078595412,3537418867,1870168139,2028553975,1682790126,340635940,3487094012,445770472,3180552619,827365636,3899776205,2678516068,2928766469,2523089326,1544583927,2480445868,25059490,628011049,534030143,4170423773,875656408,3091393555,2037542700,1532045649,1141911976,2780439328,1055640734,2256501609,1587646446,3961881818,1922084283,3815870426,1462890383,2510425470,2412374745,2133312881,2481311933,3176828778,406793081,1459898943,1581505357,446908790,1862155794,391389634,1337983029,2167916805,894031543,2972205793,3981874314,3970873540,904702946,4281281793,2011341563,1730040502,449447927,1392479146,1079943767],"primes":[[4194895487,2019100567,288166068,3420769453,578087955,144710467,2455684951,2290410576,769352734,1683603247,3742735841,2112729998,3689821774,2841117347,1945557644,1743471659,1789336052,3409611568,2427879267,3494586315,3683981184,2933731708,3487316595,1772371330,1823785759,3813045124,1304563176,2625727395,4034751701,389170009,2539914550,3417039931],[3745749099,117137048,2535594633,4009287526,3011582450,3686928199,2246015868,2190556989,128754455,251282487,1322369199,336317848,783652423,2196981797,1304603190,305597228,4230817681,893020485,2847642738,3082596049,2148113249,674456457,1003703807,3602735589,2874372484,3869771314,1591665775,4272594151,4176695394,4205601753,1503030929,4248761093]]},"rsa_public_key":{"n":[836640533,2811245416,716324048,2993722125,2443208307,1207933224,1763966872,768230429,2698832834,1722770511,3481056265,2483454227,1581944854,1854441585,1267604383,225507178,2248629754,222796813,436665417,2767570513,1751460175,3567334893,158551180,1936216845,4143458509,3490367465,4084860363,1721850123,1379384883,3483780499,4242230917,2422006539,1537799438,3474259944,2996099166,2549725424,2874957611,1494382397,462245471,1722720530,1143308317,1819787583,3197383042,4024279149,1536879499,298310184,1814074952,136661287,782643024,1746597339,900351955,2634931530,4259949916,2983184200,2755062806,1675383366,4274792210,2929612017,3247824938,3718374389,1609377025,274078680,2522020422,3380278664],"e":[65537]}}
Generate_Key_Pair_CACHE: 856.716ms
```

